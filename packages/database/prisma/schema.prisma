generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  passwordHash  String
  name          String?
  role          String         @default("user") // user, admin
  quota         Int            @default(5)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  domains       Domain[]
  apiKeys       ApiKey[]
  inviteCodes   InviteCode[]
  
  @@map("users")
}

model DNSProvider {
  id            String         @id @default(cuid())
  name          String         @unique // cloudflare, aliyun, aws
  displayName   String
  isActive      Boolean        @default(true)
  configSchema  Json           // 配置字段的 JSON Schema
  createdAt     DateTime       @default(now())
  
  dnsAccounts   DNSAccount[]
  
  @@map("dns_providers")
}

model DNSAccount {
  id            String         @id @default(cuid())
  providerId    String
  name          String         // DNS账号的名称，便于管理员识别
  credentials   String         // 加密存储的凭证
  isDefault     Boolean        @default(false)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  provider      DNSProvider    @relation(fields: [providerId], references: [id])
  domains       Domain[]
  availableDomains AvailableDomain[]
  
  @@map("dns_accounts")
}

model AvailableDomain {
  id            String         @id @default(cuid())
  dnsAccountId  String
  domain        String         // 可用的根域名，如 example.com
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  dnsAccount    DNSAccount     @relation(fields: [dnsAccountId], references: [id], onDelete: Cascade)
  domains       Domain[]
  
  @@unique([dnsAccountId, domain])
  @@map("available_domains")
}

model Domain {
  id                String       @id @default(cuid())
  userId            String
  dnsAccountId      String
  availableDomainId String
  subdomain         String       // 只存储子域名部分，如 "test"
  recordType        String       @default("A") // A, AAAA, CNAME
  value             String
  providerRecordId  String?      // DNS 服务商返回的记录 ID
  status            String       @default("active") // active, pending, rejected
  ttl               Int          @default(300)
  proxied           Boolean      @default(false) // 是否启用代理（仅 Cloudflare 支持）
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  dnsAccount        DNSAccount   @relation(fields: [dnsAccountId], references: [id])
  availableDomain   AvailableDomain @relation(fields: [availableDomainId], references: [id])
  
  @@unique([subdomain, availableDomainId])
  @@index([userId])
  @@index([status])
  @@map("domains")
}

model ApiKey {
  id            String         @id @default(cuid())
  userId        String
  key           String         @unique
  name          String
  isActive      Boolean        @default(true)
  lastUsedAt    DateTime?
  createdAt     DateTime       @default(now())
  
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("api_keys")
}

model ApiLog {
  id            String         @id @default(cuid())
  userId        String?
  action        String
  provider      String?
  status        String
  errorMessage  String?
  metadata      Json?
  createdAt     DateTime       @default(now())
  
  @@index([userId])
  @@index([createdAt])
  @@map("api_logs")
}

model BlockedSubdomain {
  id            String         @id @default(cuid())
  subdomain     String         @unique // 被禁用的子域名，如 "admin", "api", "www"
  reason        String?        // 禁用原因
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@map("blocked_subdomains")
}

model SystemSetting {
  id            String         @id @default(cuid())
  key           String         @unique // 设置键名
  value         String         // 设置值
  description   String?        // 设置描述
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@map("system_settings")
}

model InviteCode {
  id          String    @id @default(cuid())
  code        String    @unique
  description String?
  maxUses     Int       @default(1)
  usedCount   Int       @default(0)
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  createdBy   String
  creator     User      @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("invite_codes")
}
